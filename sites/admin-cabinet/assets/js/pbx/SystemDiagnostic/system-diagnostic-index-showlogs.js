"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global ace, PbxApi */
var updateLogViewWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  errorCounts: 0,
  initialize: function initialize() {
    updateLogViewWorker.restartWorker();
  },
  restartWorker: function restartWorker() {
    window.clearTimeout(updateLogViewWorker.timeoutHandle);
    updateLogViewWorker.worker();
  },
  worker: function worker() {
    systemDiagnosticLogs.updateLogFromServer();
    updateLogViewWorker.timeoutHandle = window.setTimeout(updateLogViewWorker.worker, updateLogViewWorker.timeOut);
  },
  stop: function stop() {
    window.clearTimeout(updateLogViewWorker.timeoutHandle);
  }
};
var systemDiagnosticLogs = {
  $showBtn: $('#show-last-log'),
  $downloadBtn: $('#download-file'),
  $showAutoBtn: $('#show-last-log-auto'),
  $logContent: $('#log-content-readonly'),
  viewer: '',
  $fileSelectDropDown: $('#system-diagnostic-form .filenames-select'),
  logsItems: [],
  defaultLogItem: null,
  $dimmer: $('#get-logs-dimmer'),
  $formObj: $('#system-diagnostic-form'),
  $fileName: $('#system-diagnostic-form .filename'),
  initialize: function initialize() {
    var aceHeight = window.innerHeight - 250;
    systemDiagnosticLogs.$dimmer.closest('div').css('min-height', "".concat(aceHeight, "px"));
    systemDiagnosticLogs.$fileSelectDropDown.dropdown({
      values: systemDiagnosticLogs.logsItems,
      onChange: systemDiagnosticLogs.cbOnChangeFile,
      ignoreCase: true,
      fullTextSearch: true,
      forceSelection: false
    });
    systemDiagnosticLogs.initializeAce();
    PbxApi.SyslogGetLogsList(systemDiagnosticLogs.cbFormatDropdownResults);
    systemDiagnosticLogs.$showBtn.on('click', function (e) {
      e.preventDefault();
      systemDiagnosticLogs.updateLogFromServer();
    });
    systemDiagnosticLogs.$downloadBtn.on('click', function (e) {
      e.preventDefault();
      var data = systemDiagnosticLogs.$formObj.form('get values');
      PbxApi.SyslogDownloadLogFile(data.filename, systemDiagnosticLogs.cbDownloadFile);
    });
    systemDiagnosticLogs.$showAutoBtn.on('click', function (e) {
      e.preventDefault();
      var $reloadIcon = systemDiagnosticLogs.$showAutoBtn.find('i.refresh');

      if ($reloadIcon.hasClass('loading')) {
        $reloadIcon.removeClass('loading');
        updateLogViewWorker.stop();
      } else {
        $reloadIcon.addClass('loading');
        updateLogViewWorker.initialize();
      }
    });
    $('input').keyup(function (event) {
      if (event.keyCode === 13) {
        systemDiagnosticLogs.updateLogFromServer();
      }
    });
  },
  initializeAce: function initializeAce() {
    systemDiagnosticLogs.viewer = ace.edit('log-content-readonly');

    var julia = ace.require('ace/mode/julia');

    if (julia !== undefined) {
      var IniMode = julia.Mode;
      systemDiagnosticLogs.viewer.session.setMode(new IniMode());
    }

    systemDiagnosticLogs.viewer.setTheme('ace/theme/monokai');
    systemDiagnosticLogs.viewer.renderer.setShowGutter(false);
    systemDiagnosticLogs.viewer.setOptions({
      showLineNumbers: false,
      showPrintMargin: false,
      readOnly: true
    });
    $(window).load(function () {
      var aceHeight = window.innerHeight - systemDiagnosticLogs.$logContent.offset().top - 50;
      $('.log-content-readonly').css('min-height', "".concat(aceHeight, "px"));
      systemDiagnosticLogs.viewer.resize();
    });
  },

  /**
   * Makes formatted menu structure
   */
  cbFormatDropdownResults: function cbFormatDropdownResults(response) {
    if (response === false) {
      return;
    }

    systemDiagnosticLogs.logsItems = [];
    var files = response.files;
    $.each(files, function (index, item) {
      systemDiagnosticLogs.logsItems.push({
        name: "".concat(index, " (").concat(item.size, ")"),
        value: item.path,
        selected: item["default"]
      });
    });
    systemDiagnosticLogs.$fileSelectDropDown.dropdown('change values', systemDiagnosticLogs.logsItems);
  },

  /**
   * Callback after change log file in select
   * @param value
   */
  cbOnChangeFile: function cbOnChangeFile(value) {
    if (value.length === 0) {
      return;
    }

    systemDiagnosticLogs.$formObj.form('set value', 'filename', value);
    systemDiagnosticLogs.updateLogFromServer();
  },

  /**
   * Asks log file content from server
   */
  updateLogFromServer: function updateLogFromServer() {
    var params = systemDiagnosticLogs.$formObj.form('get values');
    PbxApi.SyslogGetLogFromFile(params, systemDiagnosticLogs.cbUpdateLogText);
  },

  /**
   * Updates log view
   * @param data
   */
  cbUpdateLogText: function cbUpdateLogText(data) {
    systemDiagnosticLogs.viewer.getSession().setValue(data.content);
    var row = systemDiagnosticLogs.viewer.session.getLength() - 1;
    var column = systemDiagnosticLogs.viewer.session.getLine(row).length; // or simply Infinity

    systemDiagnosticLogs.viewer.gotoLine(row + 1, column);
    systemDiagnosticLogs.$dimmer.removeClass('active');
  },

  /**
   * After push button download file
   * @param response
   */
  cbDownloadFile: function cbDownloadFile(response) {
    if (response !== false) {
      window.location = response.filename;
    }
  }
};
$(document).ready(function () {
  systemDiagnosticLogs.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TeXN0ZW1EaWFnbm9zdGljL3N5c3RlbS1kaWFnbm9zdGljLWluZGV4LXNob3dsb2dzLmpzIl0sIm5hbWVzIjpbInVwZGF0ZUxvZ1ZpZXdXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwiaW5pdGlhbGl6ZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwic3lzdGVtRGlhZ25vc3RpY0xvZ3MiLCJ1cGRhdGVMb2dGcm9tU2VydmVyIiwic2V0VGltZW91dCIsInN0b3AiLCIkc2hvd0J0biIsIiQiLCIkZG93bmxvYWRCdG4iLCIkc2hvd0F1dG9CdG4iLCIkbG9nQ29udGVudCIsInZpZXdlciIsIiRmaWxlU2VsZWN0RHJvcERvd24iLCJsb2dzSXRlbXMiLCJkZWZhdWx0TG9nSXRlbSIsIiRkaW1tZXIiLCIkZm9ybU9iaiIsIiRmaWxlTmFtZSIsImFjZUhlaWdodCIsImlubmVySGVpZ2h0IiwiY2xvc2VzdCIsImNzcyIsImRyb3Bkb3duIiwidmFsdWVzIiwib25DaGFuZ2UiLCJjYk9uQ2hhbmdlRmlsZSIsImlnbm9yZUNhc2UiLCJmdWxsVGV4dFNlYXJjaCIsImZvcmNlU2VsZWN0aW9uIiwiaW5pdGlhbGl6ZUFjZSIsIlBieEFwaSIsIlN5c2xvZ0dldExvZ3NMaXN0IiwiY2JGb3JtYXREcm9wZG93blJlc3VsdHMiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImRhdGEiLCJmb3JtIiwiU3lzbG9nRG93bmxvYWRMb2dGaWxlIiwiZmlsZW5hbWUiLCJjYkRvd25sb2FkRmlsZSIsIiRyZWxvYWRJY29uIiwiZmluZCIsImhhc0NsYXNzIiwicmVtb3ZlQ2xhc3MiLCJhZGRDbGFzcyIsImtleXVwIiwiZXZlbnQiLCJrZXlDb2RlIiwiYWNlIiwiZWRpdCIsImp1bGlhIiwicmVxdWlyZSIsInVuZGVmaW5lZCIsIkluaU1vZGUiLCJNb2RlIiwic2Vzc2lvbiIsInNldE1vZGUiLCJzZXRUaGVtZSIsInJlbmRlcmVyIiwic2V0U2hvd0d1dHRlciIsInNldE9wdGlvbnMiLCJzaG93TGluZU51bWJlcnMiLCJzaG93UHJpbnRNYXJnaW4iLCJyZWFkT25seSIsImxvYWQiLCJvZmZzZXQiLCJ0b3AiLCJyZXNpemUiLCJyZXNwb25zZSIsImZpbGVzIiwiZWFjaCIsImluZGV4IiwiaXRlbSIsInB1c2giLCJuYW1lIiwic2l6ZSIsInZhbHVlIiwicGF0aCIsInNlbGVjdGVkIiwibGVuZ3RoIiwicGFyYW1zIiwiU3lzbG9nR2V0TG9nRnJvbUZpbGUiLCJjYlVwZGF0ZUxvZ1RleHQiLCJnZXRTZXNzaW9uIiwic2V0VmFsdWUiLCJjb250ZW50Iiwicm93IiwiZ2V0TGVuZ3RoIiwiY29sdW1uIiwiZ2V0TGluZSIsImdvdG9MaW5lIiwibG9jYXRpb24iLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ0E7QUFHQSxJQUFNQSxtQkFBbUIsR0FBRztBQUMzQkMsRUFBQUEsT0FBTyxFQUFFLElBRGtCO0FBRTNCQyxFQUFBQSxhQUFhLEVBQUUsRUFGWTtBQUczQkMsRUFBQUEsV0FBVyxFQUFFLENBSGM7QUFJM0JDLEVBQUFBLFVBSjJCLHdCQUlkO0FBQ1pKLElBQUFBLG1CQUFtQixDQUFDSyxhQUFwQjtBQUNBLEdBTjBCO0FBTzNCQSxFQUFBQSxhQVAyQiwyQkFPWDtBQUNmQyxJQUFBQSxNQUFNLENBQUNDLFlBQVAsQ0FBb0JQLG1CQUFtQixDQUFDUSxhQUF4QztBQUNBUixJQUFBQSxtQkFBbUIsQ0FBQ1MsTUFBcEI7QUFDQSxHQVYwQjtBQVczQkEsRUFBQUEsTUFYMkIsb0JBV2xCO0FBQ1JDLElBQUFBLG9CQUFvQixDQUFDQyxtQkFBckI7QUFDQVgsSUFBQUEsbUJBQW1CLENBQUNRLGFBQXBCLEdB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QUFDQXZGLElBQUFBLG9CQUFvQixDQUFDYSxPQUFyQixDQUE2QjZCLFdBQTdCLENBQXlDLFFBQXpDO0FBQ0EsR0ExSDJCOztBQTJINUI7QUFDRDtBQUNBO0FBQ0E7QUFDQ0osRUFBQUEsY0EvSDRCLDBCQStIYjZCLFFBL0hhLEVBK0hKO0FBQ3ZCLFFBQUlBLFFBQVEsS0FBRyxLQUFmLEVBQXFCO0FBQ3BCdkUsTUFBQUEsTUFBTSxDQUFDOEYsUUFBUCxHQUFrQnZCLFFBQVEsQ0FBQzlCLFFBQTNCO0FBQ0E7QUFDRDtBQW5JMkIsQ0FBN0I7QUFzSUFoQyxDQUFDLENBQUNzRixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCNUYsRUFBQUEsb0JBQW9CLENBQUNOLFVBQXJCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuLyogZ2xvYmFsIGFjZSwgUGJ4QXBpICovXG5cblxuY29uc3QgdXBkYXRlTG9nVmlld1dvcmtlciA9IHtcblx0dGltZU91dDogMzAwMCxcblx0dGltZU91dEhhbmRsZTogJycsXG5cdGVycm9yQ291bnRzOiAwLFxuXHRpbml0aWFsaXplKCkge1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuXHR9LFxuXHRyZXN0YXJ0V29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQodXBkYXRlTG9nVmlld1dvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLndvcmtlcigpO1xuXHR9LFxuXHR3b3JrZXIoKSB7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuXHRcdFx0dXBkYXRlTG9nVmlld1dvcmtlci53b3JrZXIsXG5cdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLnRpbWVPdXQsXG5cdFx0KTtcblx0fSxcblx0c3RvcCgpIHtcblx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdH1cbn07XG5cbmNvbnN0IHN5c3RlbURpYWdub3N0aWNMb2dzID0ge1xuXHQkc2hvd0J0bjogJCgnI3Nob3ctbGFzdC1sb2cnKSxcblx0JGRvd25sb2FkQnRuOiAkKCcjZG93bmxvYWQtZmlsZScpLFxuXHQkc2hvd0F1dG9CdG46ICQoJyNzaG93LWxhc3QtbG9nLWF1dG8nKSxcblx0JGxvZ0NvbnRlbnQ6ICQoJyNsb2ctY29udGVudC1yZWFkb25seScpLFxuXHR2aWV3ZXI6ICcnLFxuXHQkZmlsZVNlbGVjdERyb3BEb3duOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWVzLXNlbGVjdCcpLFxuXHRsb2dzSXRlbXM6IFtdLFxuXHRkZWZhdWx0TG9nSXRlbTogbnVsbCxcblx0JGRpbW1lcjogJCgnI2dldC1sb2dzLWRpbW1lcicpLFxuXHQkZm9ybU9iajogJCgnI3N5c3RlbS1kaWFnbm9zdGljLWZvcm0nKSxcblx0JGZpbGVOYW1lOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWUnKSxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHRjb25zdCBhY2VIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQtMjUwO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkaW1tZXIuY2xvc2VzdCgnZGl2JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZpbGVTZWxlY3REcm9wRG93bi5kcm9wZG93bihcblx0XHRcdHtcblx0XHRcdFx0dmFsdWVzOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMsXG5cdFx0XHRcdG9uQ2hhbmdlOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYk9uQ2hhbmdlRmlsZSxcblx0XHRcdFx0aWdub3JlQ2FzZTogdHJ1ZSxcblx0XHRcdFx0ZnVsbFRleHRTZWFyY2g6IHRydWUsXG5cdFx0XHRcdGZvcmNlU2VsZWN0aW9uOiBmYWxzZSxcblx0XHRcdH1cblx0XHQpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmluaXRpYWxpemVBY2UoKTtcblx0XHRQYnhBcGkuU3lzbG9nR2V0TG9nc0xpc3Qoc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JGb3JtYXREcm9wZG93blJlc3VsdHMpO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dCdG4ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKTtcblx0XHR9KTtcblxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkb3dubG9hZEJ0bi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0Y29uc3QgZGF0YSA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0XHRcdFBieEFwaS5TeXNsb2dEb3dubG9hZExvZ0ZpbGUoZGF0YS5maWxlbmFtZSwgc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JEb3dubG9hZEZpbGUpO1xuXHRcdH0pO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dBdXRvQnRuLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRjb25zdCAkcmVsb2FkSWNvbiA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRzaG93QXV0b0J0bi5maW5kKCdpLnJlZnJlc2gnKTtcblx0XHRcdGlmICgkcmVsb2FkSWNvbi5oYXNDbGFzcygnbG9hZGluZycpKXtcblx0XHRcdFx0JHJlbG9hZEljb24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0dXBkYXRlTG9nVmlld1dvcmtlci5zdG9wKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQkcmVsb2FkSWNvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLmluaXRpYWxpemUoKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHQkKCdpbnB1dCcpLmtleXVwKChldmVudCk9PiB7XG5cdFx0XHRpZiAoZXZlbnQua2V5Q29kZSA9PT0gMTMpIHtcblx0XHRcdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9LFxuXHRpbml0aWFsaXplQWNlKCkge1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlciA9IGFjZS5lZGl0KCdsb2ctY29udGVudC1yZWFkb25seScpO1xuXG5cdFx0Y29uc3QganVsaWEgPSBhY2UucmVxdWlyZSgnYWNlL21vZGUvanVsaWEnKTtcblx0XHRpZiAoanVsaWEhPT11bmRlZmluZWQpe1xuXHRcdFx0Y29uc3QgSW5pTW9kZSA9IGp1bGlhLk1vZGU7XG5cdFx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2Vzc2lvbi5zZXRNb2RlKG5ldyBJbmlNb2RlKCkpO1xuXHRcdH1cblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2V0VGhlbWUoJ2FjZS90aGVtZS9tb25va2FpJyk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnJlbmRlcmVyLnNldFNob3dHdXR0ZXIoZmFsc2UpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXRPcHRpb25zKHtcblx0XHRcdHNob3dMaW5lTnVtYmVyczpmYWxzZSxcblx0XHRcdHNob3dQcmludE1hcmdpbjogZmFsc2UsXG5cdFx0XHRyZWFkT25seTogdHJ1ZSxcblx0XHR9KTtcblx0XHQkKHdpbmRvdykubG9hZChmdW5jdGlvbigpIHtcblx0XHRcdGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodC1zeXN0ZW1EaWFnbm9zdGljTG9ncy4kbG9nQ29udGVudC5vZmZzZXQoKS50b3AtNTA7XG5cdFx0XHQkKCcubG9nLWNvbnRlbnQtcmVhZG9ubHknKS5jc3MoJ21pbi1oZWlnaHQnLCBgJHthY2VIZWlnaHR9cHhgKTtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5yZXNpemUoKTtcblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqIE1ha2VzIGZvcm1hdHRlZCBtZW51IHN0cnVjdHVyZVxuXHQgKi9cblx0Y2JGb3JtYXREcm9wZG93blJlc3VsdHMocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UgPT09ZmFsc2Upe1xuXHRcdFx0cmV0dXJuIDtcblx0XHR9XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zID0gW107XG5cdFx0Y29uc3QgZmlsZXMgPSByZXNwb25zZS5maWxlcztcblx0XHQkLmVhY2goZmlsZXMsIChpbmRleCwgaXRlbSkgPT4ge1xuXHRcdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zLnB1c2goe1xuXHRcdFx0XHRuYW1lOiBgJHtpbmRleH0gKCR7aXRlbS5zaXplfSlgLFxuXHRcdFx0XHR2YWx1ZTogaXRlbS5wYXRoLFxuXHRcdFx0XHRzZWxlY3RlZDogaXRlbS5kZWZhdWx0XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZmlsZVNlbGVjdERyb3BEb3duLmRyb3Bkb3duKCdjaGFuZ2UgdmFsdWVzJywgc3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zKTtcblx0fSxcblx0LyoqXG5cdCAqIENhbGxiYWNrIGFmdGVyIGNoYW5nZSBsb2cgZmlsZSBpbiBzZWxlY3Rcblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqL1xuXHRjYk9uQ2hhbmdlRmlsZSh2YWx1ZSkge1xuXHRcdGlmICh2YWx1ZS5sZW5ndGg9PT0wKXtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZvcm1PYmouZm9ybSgnc2V0IHZhbHVlJywgJ2ZpbGVuYW1lJywgdmFsdWUpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKTtcblx0fSxcblx0LyoqXG5cdCAqIEFza3MgbG9nIGZpbGUgY29udGVudCBmcm9tIHNlcnZlclxuXHQgKi9cblx0dXBkYXRlTG9nRnJvbVNlcnZlcigpe1xuXHRcdGNvbnN0IHBhcmFtcyA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0XHRQYnhBcGkuU3lzbG9nR2V0TG9nRnJvbUZpbGUocGFyYW1zLCBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYlVwZGF0ZUxvZ1RleHQpO1xuXHR9LFxuXHQvKipcblx0ICogVXBkYXRlcyBsb2cgdmlld1xuXHQgKiBAcGFyYW0gZGF0YVxuXHQgKi9cblx0Y2JVcGRhdGVMb2dUZXh0KGRhdGEpIHtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKGRhdGEuY29udGVudCk7XG5cdFx0Y29uc3Qgcm93ID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnNlc3Npb24uZ2V0TGVuZ3RoKCkgLSAxO1xuXHRcdGNvbnN0IGNvbHVtbiA9IHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXNzaW9uLmdldExpbmUocm93KS5sZW5ndGg7IC8vIG9yIHNpbXBseSBJbmZpbml0eVxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5nb3RvTGluZShyb3cgKyAxLCBjb2x1bW4pO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkaW1tZXIucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xuXHR9LFxuXHQvKipcblx0ICogQWZ0ZXIgcHVzaCBidXR0b24gZG93bmxvYWQgZmlsZVxuXHQgKiBAcGFyYW0gcmVzcG9uc2Vcblx0ICovXG5cdGNiRG93bmxvYWRGaWxlKHJlc3BvbnNlKXtcblx0XHRpZiAocmVzcG9uc2UhPT1mYWxzZSl7XG5cdFx0XHR3aW5kb3cubG9jYXRpb24gPSByZXNwb25zZS5maWxlbmFtZTtcblx0XHR9XG5cdH0sXG59O1xuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG5cdHN5c3RlbURpYWdub3N0aWNMb2dzLmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=